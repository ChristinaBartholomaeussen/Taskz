<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>GANT CHART</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" th:inline="javascript">
        google.charts.load('current', {'packages':['gantt']});
        google.charts.setOnLoadCallback(drawChart);

        function daysToMilliseconds(days) {
            return days * 24 * 60 * 60 * 1000;
        }

        function drawChart() {

            var projects = [[${projects}]];

            var data = new google.visualization.DataTable();

            data.addColumn('string', 'Task ID');
            data.addColumn('string', 'Task Name');
            data.addColumn('string', 'Resource');
            data.addColumn('date', 'Start Date');
            data.addColumn('date', 'End Date');
            data.addColumn('number', 'Duration');
            data.addColumn('number', 'Percent Complete');
            data.addColumn('string', 'Dependencies');

            console.log(projects);

            for (var project = 0; project < projects.length; project++)
            {
                let projectStartDate = Date.parse(projects[project].startDate);
                let projectDeadLine = Date.parse(projects[project].deadline);
                let subprojects = projects[project].associatedSubprojects;
                let completedSubprojects = 0;

                data.addRows
                ([
                    [projects[project].projectId.toString(), "PROJECT: " + projects[project].name, null, new Date(projectStartDate), new Date(projectDeadLine), null, 100, null]
                ]);

                for(let subproject = 0; subproject < subprojects.length; subproject++)
                {
                    let subprojectStartDate = Date.parse(subprojects[subproject].subprojectStartDate);
                    let subprojectDeadlline = Date.parse(subprojects[subproject].subprojectDeadline);
                    let tasks = subprojects[subproject].taskList;
                    let completion = 0;

                    if(tasks.length != 0)
                    {
                        let completedTasks = 0;
                        for(let task = 0; task < tasks.length;task++)
                        {
                            if(tasks[task].status == 'COMPLETED')
                            {
                                completedTasks++;
                            }
                        }
                        completion = tasks.length / completedTasks * 100;
                        console.log("Tasks length: " + tasks.length + " completed tasks: " + completedTasks);
                    }

                    console.log("Completion: " + completion);


                    data.addRows
                    ([
                        [subprojects[subproject].subprojectId.toString(), 'SUBPROJECT: ' + subprojects[subproject].subprojectName,project.toString(), new Date(subprojectStartDate), new Date(subprojectDeadlline), null, completion, null]
                    ]);

                    for(let task = 0; task < tasks.length;task++)
                    {
                        let dateNow = Date.now();
                        let taskDeadline = Date.parse(tasks[task].deadline);
                        let isCompleted = tasks[task].status == "ACTIVE" ? 0 : 100;

                        data.addRows
                        ([
                            [tasks[task].taskId.toString(), 'TASK: ' + tasks[task].taskName,subproject.toString(),new Date(dateNow),new Date(taskDeadline),null,isCompleted,null]
                        ]);
                    }

                }
            }

            const options = {
                gantt:
                    {
                        sortTasks: false
                    },
                hAxis:
                    {
                        format: 'M/d/yy',
                        gridlines: {count: 15}
                    },
                height: data.getNumberOfRows() * 50
            };

            const chart = new google.visualization.Gantt(document.getElementById('chart_div'));

            chart.draw(data, options);
        }
    </script>
</head>
<body>

<div id="chart_div"></div>
</body>
</html>
